$sourceFolder = "$env:USERPROFILE\kydras-governance"; $archiveFolder = "$env:USERPROFILE\kydras-compliance-service\archive"; New-Item -ItemType Directory -Path $archiveFolder -Force | Out-Null; $dashboards = Get-ChildItem $sourceFolder -Filter "executive_dashboard_*.html" | Sort-Object LastWriteTime -Descending; $latest = $dashboards | Select-Object -First 1; $old = $dashboards | Where-Object { $_.FullName -ne $latest.FullName }; foreach ($file in $old) { $timestamp = $file.LastWriteTime.ToString("yyyy-MM-dd_HHmm"); $archivedName = "dashboard_$timestamp.html"; Copy-Item $file.FullName -Destination "$archiveFolder\$archivedName" -Force; Write-Host "[Kydras] Archived → $archivedName" }
$timestamp = Get-Date -Format "yyyy-MM-dd_HHmm"; $commit = git rev-parse --short HEAD; $bundleName = "kydras_artifacts_$timestamp_$commit.zip"; $bundlePath = "$env:USERPROFILE\kydras-compliance-service\artifacts\$bundleName"; New-Item -ItemType Directory -Path "$env:USERPROFILE\kydras-compliance-service\artifacts" -Force | Out-Null; Compress-Archive -Path @("$env:USERPROFILE\kydras-compliance-service\docs\index.html", "$env:USERPROFILE\kydras-compliance-service\docs\audit.md", "$env:USERPROFILE\kydras-compliance-service\README.md", "$env:USERPROFILE\kydras-compliance-service\deploy.log") -DestinationPath $bundlePath -Force; Write-Host "[Kydras] Governance bundle created → $bundlePath"
$timestamp = Get-Date -Format "yyyy-MM-dd_HHmm"; $commit = git rev-parse --short HEAD; $bucket = "s3://kydras-compliance-exports"; $bundle = Get-ChildItem "$env:USERPROFILE\kydras-compliance-service\artifacts" -Filter "kydras_artifacts_*.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 1; $pdf = Get-Item "$env:USERPROFILE\kydras-compliance-service\docs\audit.pdf"; aws s3 cp $bundle.FullName "$bucket/bundles/$($bundle.Name)" --metadata commit=$commit,timestamp=$timestamp; aws s3 cp $pdf.FullName "$bucket/pdfs/audit_$timestamp.pdf" --metadata commit=$commit,timestamp=$timestamp; Write-Host "[Kydras] Synced bundle + PDF to S3 → $bucket"
$timestamp = Get-Date -Format "yyyy-MM-dd HH:mm"; $commit = git rev-parse --short HEAD; $subject = "[Kydras] Compliance Bundle - $timestamp ($commit)"; $body = "Attached: Audit PDF, Governance Bundle, and Deploy Log.`nGenerated by CI/CD at $timestamp."; $bundle = Get-ChildItem "$env:USERPROFILE\kydras-compliance-service\artifacts" -Filter "kydras_artifacts_*.zip" | Sort-Object LastWriteTime -Descending | Select-Object -First 1; $pdf = Get-Item "$env:USERPROFILE\kydras-compliance-service\docs\audit.pdf"; $log = Get-Item "$env:USERPROFILE\kydras-compliance-service\deploy.log"; Send-MailMessage -From "ci@kydras.com" -To "exec@kydras.com" -Subject $subject -Body $body -SmtpServer "smtp.kydras.com" -Attachments $pdf.FullName, $bundle.FullName, $log.FullName
